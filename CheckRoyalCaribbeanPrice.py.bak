import argparse
import base64
import json
import locale
import os
import re
from datetime import datetime
from urllib.parse import parse_qs, urlparse

import requests
import yaml
from apprise import Apprise
from bs4 import BeautifulSoup
from dotenv import load_dotenv

# Load secrets from the .env file
load_dotenv()

# Global list to collect prices for the heartbeat summary
summary_results = []
appKey = "hyNNqIPHHzaLzVpcICPdAdbFV8yvTsAm"

# Terminal Colors
RED, GREEN, MAGENTA, CYAN, YELLOW, RESET = (
    "\033[1;31;40m",
    "\033[1;32m",
    "\033[35m",
    "\033[36m",
    "\033[33m",
    "\033[0m",
)


def main():
    global summary_results
    parser = argparse.ArgumentParser(description="Check Royal Caribbean Price")
    parser.add_argument(
        "-c",
        "--config",
        type=str,
        default="config.yaml",
        help="Path to configuration YAML file",
    )
    args = parser.parse_args()

    try:
        locale.setlocale(locale.LC_TIME, "")
    except:
        pass

    timestamp = datetime.now()

    # Load credentials from .env
    env_user = os.getenv("RC_USERNAME")
    env_pass = os.getenv("RC_PASSWORD")
    po_user = os.getenv("PUSHOVER_USER")
    po_token = os.getenv("PUSHOVER_TOKEN")

    apobj = Apprise()

    if not env_user or not env_pass:
        print(f"{RED}ERROR: RC_USERNAME or RC_PASSWORD not found in .env!{RESET}")
        return

    # Configure Notifications
    if po_user and po_token:
        print(f"{YELLOW}--- Pushover Credentials Loaded ---{RESET}")
        apobj.add(f"pover://{po_user}@{po_token}")

    with open(args.config, "r") as file:
        data = yaml.safe_load(file)
        global shipDictionary
        shipDictionary = getShipDictionary()

        # Login
        print(f"{YELLOW}--- Authenticating: {env_user} ---{RESET}")
        session = requests.session()
        try:
            access_token, accountId, session = login(
                env_user, env_pass, session, "royalcaribbean"
            )
            auth_data = {"token": access_token, "accId": accountId, "sess": session}
            getLoyalty(access_token, accountId, session)
        except Exception:
            print(f"{RED}Login Failed: Check your .env credentials.{RESET}")
            return

        # RUN CHECKS PER CRUISE
        if "cruises" in data:
            for cruise in data["cruises"]:
                cruise_name = cruise.get("name", "Royal Caribbean Cruise")
                print(f"\n{YELLOW}--- Checking: {cruise_name} ---{RESET}")

                # A. Cruise Fare Check
                if "cruiseURL" in cruise:
                    get_cruise_price(
                        cruise["cruiseURL"], float(cruise.get("paidPrice", 9999)), apobj
                    )

                # B. Purchased Items
                print(f"{YELLOW}--- Purchased Items ---{RESET}")
                getVoyages(
                    auth_data["token"],
                    auth_data["accId"],
                    auth_data["sess"],
                    apobj,
                    "royalcaribbean",
                    data.get("reservationFriendlyNames", {}),
                    gather_ids_only=False,
                )

                # C. Manual Item Goals
                if "items" in cruise:
                    print(f"{YELLOW}--- Manual Item Goals ---{RESET}")
                    ship, sail, resId, passId = (
                        cruise.get("shipCode"),
                        cruise.get("sailDate"),
                        cruise.get("bookingId"),
                        cruise.get("passengerId"),
                    )
                    for item in cruise["items"]:
                        getNewBeveragePrice(
                            auth_data["token"],
                            auth_data["accId"],
                            auth_data["sess"],
                            resId,
                            ship,
                            sail,
                            item["category"],
                            float(item["targetPrice"]),
                            "CAD",
                            item["productID"],
                            apobj,
                            passId,
                            item["name"],
                            "Manual",
                            "MANUAL",
                            "N/A",
                            True,
                            is_manual=True,
                        )

    # Heartbeat Report
    print(f"{YELLOW}--- Sending Heartbeat Notification ---{RESET}")
    report_body = f"Price Check Report ({timestamp.strftime('%I:%M %p')}):\n"
    report_body += (
        "\n".join(summary_results) if summary_results else "No items tracked."
    )
    apobj.notify(body=report_body, title="RC Tracker Heartbeat", priority=-2)
    print(f"{YELLOW}--- Script Finished ---{RESET}")


def login(username, password, session, cruiseLineName):
    headers = {
        "Content-Type": "application/x-www-form-urlencoded",
        "Authorization": "Basic ZzlTMDIzdDc0NDczWlVrOTA5Rk42OEYwYjRONjdQU09oOTJvMDR2TDBCUjY1MzdwSTJ5Mmg5NE02QmJVN0Q2SjpXNjY4NDZrUFF2MTc1MDk3NW9vZEg1TTh6QzZUYTdtMzBrSDJRNzhsMldtVTUwRkNncXBQMTN3NzczNzdrN0lC",
        "User-Agent": "Mozilla/5.0",
    }
    data = f"grant_type=password&username={username}&password={password}&scope=openid+profile+email+vdsid"
    response = session.post(
        f"https://www.{cruiseLineName}.com/auth/oauth2/access_token",
        headers=headers,
        data=data,
    )
    access_token = response.json().get("access_token")
    auth_info = json.loads(
        base64.b64decode(access_token.split(".")[1] + "==").decode("utf-8")
    )
    return access_token, auth_info["sub"], session


def getNewBeveragePrice(
    access_token,
    accountId,
    session,
    reservationId,
    ship,
    startDate,
    prefix,
    paidPrice,
    currency,
    product,
    apobj,
    passengerId,
    passengerName,
    room,
    orderCode,
    orderDate,
    owner,
    is_manual=False,
):
    global summary_results
    headers = {"Access-Token": access_token, "AppKey": appKey, "vds-id": accountId}
    params = {
        "reservationId": reservationId,
        "startDate": startDate,
        "currencyIso": currency,
        "passengerId": passengerId,
    }
    try:
        url = f"https://aws-prd.api.rccl.com/en/royal/web/commerce-api/catalog/v2/{ship}/categories/{prefix}/products/{product}"
        response = session.get(url, params=params, headers=headers)
        payload = response.json().get("payload")
        if not payload:
            return
        title = payload.get("title")
        price_payload = payload.get("startingFromPrice")
        if not price_payload:
            return
        current = float(
            price_payload.get("adultPromotionalPrice")
            or price_payload.get("adultShipboardPrice")
        )
        summary_results.append(f"• {title}: ${current:.2f}")
        label = "Goal" if is_manual else "Paid"
        output_color = GREEN
        if current < paidPrice:
            output_color = RED
            msg = f"REBOOK! {title} is ${current:.2f} ({label}: ${paidPrice:.2f})"
            print(f"{RED}{msg}{RESET}")
            apobj.notify(body=msg, title="Price Alert", priority=1)
        else:
            if is_manual:
                if current <= (paidPrice * 1.05):
                    output_color = CYAN
                elif current <= (paidPrice * 1.10):
                    output_color = MAGENTA
            print(
                f"{output_color}{title} is ${current:.2f}{RESET} ({label}: ${paidPrice:.2f})"
            )
    except:
        pass


def getLoyalty(access_token, accountId, session):
    headers = {"Access-Token": access_token, "AppKey": appKey, "account-id": accountId}
    response = session.get(
        "https://aws-prd.api.rccl.com/en/royal/web/v1/guestAccounts/loyalty/info",
        headers=headers,
    )
    loyalty = response.json().get("payload").get("loyaltyInformation")
    print(
        f"C&A Status: {loyalty.get('crownAndAnchorId')} ({loyalty.get('crownAndAnchorSocietyLoyaltyTier')})"
    )


def getVoyages(
    access_token,
    accountId,
    session,
    apobj,
    cruiseLineName,
    reservationFriendlyNames,
    gather_ids_only=False,
):
    headers = {"Access-Token": access_token, "AppKey": appKey, "vds-id": accountId}
    brand = "R" if cruiseLineName == "royalcaribbean" else "C"
    response = requests.get(
        f"https://aws-prd.api.rccl.com/v1/profileBookings/enriched/{accountId}",
        params={"brand": brand, "includeCheckin": "false"},
        headers=headers,
    )
    for booking in response.json().get("payload").get("profileBookings"):
        resId, ship, sail = (
            booking.get("bookingId"),
            booking.get("shipCode"),
            booking.get("sailDate"),
        )
        getOrders(
            access_token,
            accountId,
            session,
            resId,
            booking.get("passengerId"),
            ship,
            sail,
            booking.get("numberOfNights"),
            apobj,
            gather_ids_only,
        )


def getOrders(
    access_token,
    accountId,
    session,
    reservationId,
    passengerId,
    ship,
    startDate,
    numberOfNights,
    apobj,
    gather_ids_only=False,
):
    headers = {
        "Access-Token": accountId,
        "AppKey": appKey,
        "Account-Id": accountId,
        "Access-Token": access_token,
    }
    params = {
        "passengerId": passengerId,
        "reservationId": reservationId,
        "sailingId": ship + startDate,
        "currencyIso": "CAD",
        "includeMedia": "false",
    }
    response = requests.get(
        f"https://aws-prd.api.rccl.com/en/royal/web/commerce-api/calendar/v1/{ship}/orderHistory",
        params=params,
        headers=headers,
    )
    for order in response.json().get("payload").get("myOrders") + response.json().get(
        "payload"
    ).get("ordersOthersHaveBookedForMe"):
        if order.get("orderTotals").get("total") > 0:
            details = requests.get(
                f"https://aws-prd.api.rccl.com/en/royal/web/commerce-api/calendar/v1/{ship}/orderHistory/{order.get('orderCode')}",
                params=params,
                headers=headers,
            )
            for item in details.json().get("payload").get("orderHistoryDetailItems"):
                prefix, product = (
                    item.get("productSummary").get("productTypeCategory").get("id"),
                    item.get("productSummary").get("baseId"),
                )
                for guest in item.get("guests"):
                    if guest.get("orderStatus") == "CANCELLED":
                        continue
                    if gather_ids_only:
                        print(
                            f"Authorized Guest: {guest.get('firstName')} (ID: {guest.get('id')})"
                        )
                    else:
                        paid = guest.get("priceDetails").get("subtotal")
                        if item.get("productSummary").get("salesUnit") in [
                            "PER_NIGHT",
                            "PER_DAY",
                        ]:
                            paid = round(paid / numberOfNights, 2)
                        if guest.get("priceDetails").get("quantity") > 0:
                            paid = round(
                                paid / guest.get("priceDetails").get("quantity"), 2
                            )
                        currency = guest.get("priceDetails").get("currency")
                        getNewBeveragePrice(
                            access_token,
                            accountId,
                            session,
                            reservationId,
                            ship,
                            startDate,
                            prefix,
                            paid,
                            currency,
                            product,
                            apobj,
                            guest.get("id"),
                            guest.get("firstName"),
                            guest.get("stateroomNumber"),
                            order.get("orderCode"),
                            order.get("orderDate"),
                            order.get("owner"),
                            is_manual=False,
                        )


def get_cruise_price(url, paidPrice, apobj):
    global summary_results
    headers = {
        "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
    }
    params = parse_qs(urlparse(url).query)
    shipCode, shipName = (
        params.get("shipCode")[0],
        shipDictionary.get(params.get("shipCode")[0], "Cruise"),
    )
    try:
        response = requests.get(
            f"https://www.royalcaribbean.com/checkout/guest-info",
            params=params,
            headers=headers,
        )
        print(f"Cruise Price Check Status Code: {response.status_code}")
        with open("cruise_price_page.html", "w") as f:
            f.write(response.text)
        soup = BeautifulSoup(response.text, "html.parser")
        print(f"Cruise Price Check Page Title: {soup.title.string if soup.title else 'No Title Found'}")
        soupFind = (
            soup.find("span", attrs={"data-testid": "pricing-total"})
            or soup.find("span", class_=re.compile("SummaryPrice_title"))
            or soup.find(string=re.compile(r"\$\d+,\d+\.\d+"))
        )
        print(f"Cruise Price Check soupFind: {soupFind}")
        if soupFind:
            price_str = re.sub(
                r"[^\d.]", "", soupFind.string if soupFind.string else soupFind.text
            )
            current = float(price_str)
            summary_results.append(f"• {shipName} Cabin: ${current:.2f}")
            if current < paidPrice:
                msg = f"REBOOK! {shipName} Cabin is ${current:.2f} (Paid: ${paidPrice:.2f})"
                print(f"{RED}{msg}{RESET}")
                apobj.notify(body=msg, title="Cruise Price Alert", priority=1)
            else:
                print(
                    f"{GREEN}{shipName} Cabin is ${current:.2f}{RESET} (Paid: ${paidPrice:.2f})"
                )
    except Exception as e:
        print(f"An error occurred in get_cruise_price: {e}")


def getShipDictionary():

    headers = {
        'appkey': 'cdCNc04srNq4rBvKofw1aC50dsdSaPuc',
        'accept': 'application/json',
        'appversion': '1.54.0',
        'accept-language': 'en',
        'user-agent': 'okhttp/4.10.0',
    }

    params = {
        'sort': 'name',
    }

    response = requests.get('https://api.rccl.com/en/all/mobile/v2/ships', params=params, headers=headers)
    ships = response.json().get("payload").get("ships")

    shipCodes = {}

    for ship in ships:
        shipCode = ship.get("shipCode")
        name = ship.get("name")
        shipCodes[shipCode] = name
    return shipCodes


if __name__ == "__main__":
    main()
